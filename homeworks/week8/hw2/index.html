<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitch Top Games</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Odibee+Sans&family=Roboto+Condensed:wght@400;700&family=Squada+One&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar__top-games">
    <a class="navbar__game" href="#">1</a>
    <a class="navbar__game" href="#">2</a>
    <a class="navbar__game" href="#">3</a>
    <a class="navbar__game" href="#">4</a>
    <a class="navbar__game"href="#">5</a>
  </nav>
  <section class="streams">
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>
    <div class="stream__block hide">
      <div class="stream__preview"></div>
      <div class="stream__info">
        <div class="stream__logo"></div>
        <div class="stream__content">
          <div class="stream__game"></div>
          <div class="stream__display-name"></div>
          <div class="stream__viewers"></div>
        </div>
      </div>
    </div>

    
  </section>
  <script>
    //發送取得熱門遊戲名單的 request
    const request = new XMLHttpRequest()
    request.open('GET', 'https://api.twitch.tv/kraken/games/top?limit=5', true)
    request.setRequestHeader('Client-ID', '5h0cpu5wohpm88atbxwccndu8uzwrr')
    request.setRequestHeader('Accept', 'application/vnd.twitchtv.v5+json')
    request.send()
    request.onload = function() {
      if(request.status >= 200 && request.status < 400) {
        let json
        try {
          json = JSON.parse(request.responseText)
        } catch (err) {
          console.log('Please check your data, it is not JSON');
        }
        let topGames = json.top
        let topGamesNames = []
        for(game of topGames) {
          topGamesNames.push(game.game.name);  //["League of Legends", "Just Chatting", "World of Warcraft", "Call of Duty: Warzone", "Counter-Strike: Global Offensive"]
        }
        //改變 Nav Bar 文字
        let navBarGames = document.querySelectorAll('.navbar__game')
        for(let i = 0; i < navBarGames.length; i++) {
          navBarGames[i].innerText = topGamesNames[i]
        }
        //處理 url encoded，避免遊戲出現奇怪字元導致 API 抓不到資料
        let topGamesNamesEncoded = []
        for(let i = 0; i < topGamesNames.length; i++) {
          topGamesNamesEncoded.push(encodeURIComponent(topGamesNames[i]))
        }
        //一到首頁就先抓取第一名的串流資料
        getGameStreams(0)
        //函式：取得該遊戲類別的串流影片
        function getGameStreams(gameIndex) {
          const streamRequest = new XMLHttpRequest()
          const streamUrl = `https://api.twitch.tv/kraken/streams?limit=20`
          streamRequest.open('GET', `${streamUrl}&game=${topGamesNamesEncoded[gameIndex]}`, true)
          streamRequest.setRequestHeader('Client-ID', '5h0cpu5wohpm88atbxwccndu8uzwrr')
          streamRequest.setRequestHeader('Accept', 'application/vnd.twitchtv.v5+json')
          streamRequest.send()
          streamRequest.onload = function() {
            if(streamRequest.status >= 200 && streamRequest.status < 400) {
              let gameStreams
              try {
                gameStreams = JSON.parse(streamRequest.responseText)
              } catch (err) {
                console.log('Please check your data, it is not JSON');
              }
              console.log('gameStreams',gameStreams);
              let streamsOfTheGame = []
              for(let i = 0; i < gameStreams.streams.length; i++) {
                let streamData = {}
                streamData['previewImage'] = gameStreams.streams[i].preview.large
                streamData['logo'] = gameStreams.streams[i].channel.logo
                streamData['gameName'] = gameStreams.streams[i].game
                streamData['displayName'] = gameStreams.streams[i].channel.display_name
                streamData['viewers'] = gameStreams.streams[i].viewers
                streamData['url'] = gameStreams.streams[i].channel.url
                streamsOfTheGame.push(streamData)
              }
              let streamBlocks = document.querySelectorAll('.stream__block')
              for(let i = 0; i < streamsOfTheGame.length; i++) {
                streamBlocks[i].classList.remove('hide')
                streamBlocks[i].querySelector('.stream__preview').style.background = `url('${streamsOfTheGame[i].previewImage}') no-repeat center center`;
                streamBlocks[i].querySelector('.stream__info .stream__logo').style.background = `url('${streamsOfTheGame[i].logo}') no-repeat center center / contain`;
                streamBlocks[i].querySelector('.stream__info .stream__content .stream__game').innerText = streamsOfTheGame[i].gameName;
                streamBlocks[i].querySelector('.stream__info .stream__content .stream__display-name').innerText = streamsOfTheGame[i].displayName;
                streamBlocks[i].querySelector('.stream__info .stream__content .stream__viewers').innerText = `${streamsOfTheGame[i].viewers} viewers`;
              }
              // 點按串流影片的 div，可以連結到該串流影片位址
              // document.querySelector('.streams').addEventListener('click', e => {

              // })
            } else {
              console.log('Stream Request Error', streamRequest.status);
            }
            streamRequest.onerror = function(){
              console.log('error');
            }
          }
        }
        //點按 Nav Bar 按鈕發送取得串流的 request
        document.querySelector('.navbar__top-games').addEventListener('click', e => {
          let gameIndex
          let gameLinks = document.querySelectorAll('.navbar__game')
          switch(e.target){
            case gameLinks[0]:
              gameIndex = 0
              getGameStreams(gameIndex)
              break
            case gameLinks[1]:
              gameIndex = 1
              getGameStreams(gameIndex)
              break
            case gameLinks[2]:
              gameIndex = 2
              getGameStreams(gameIndex)
              break
            case gameLinks[3]:
              gameIndex = 3
              getGameStreams(gameIndex)
              break
            case gameLinks[4]:
              gameIndex = 4
              getGameStreams(gameIndex)
              break
          }
      })
      } else {
        console.log('Request Error', request.status);
      }
      request.onerror = function(){
        console.log('error');
      }
    }

  </script>
</body>
</html>